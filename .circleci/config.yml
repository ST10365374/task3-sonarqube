# .circleci/config.yml - STREAMLINED VERSION
version: 2.1

orbs:
  # Using the community SonarCloud orb for simplicity
  sonarcloud: sonarcloud/sonarcloud@1.0.3

jobs:
  install_and_test:
    docker:
      # Use a stable Node image
      - image: cimg/node:20.5
    steps:
      - checkout
      - run:
          name: Install dependencies
          # Install dependencies for both backend and frontend
          command: |
            cd backend && npm ci
            cd frontend && npm ci
      - run:
          name: Run tests (with coverage)
          # Use the 'continue on error' syntax '|| true' if tests are optional
          command: |
            cd frontend && npm test -- --coverage || true 
      - persist_to_workspace:
          root: .
          paths:
            # Persist all necessary files for the Sonar scan job
            - backend
            - frontend

  # SonarCloud scan job using the official orb
  sonarcloud_scan:
    docker:
      # Use a simple, lightweight Docker image for the scan job
      - image: cimg/base:2024.03
    steps:
      - checkout
      - attach_workspace:
          at: .
      # Use the orb's command which manages the scanner, simplifies the process
      - sonarcloud/scan 

workflows:
  build_and_analyze:
    jobs:
      - install_and_test
      # The SonarCloud scan runs after the install_and_test job succeeds
      - sonarcloud_scan:
          requires:
            - install_and_test
          # CRITICAL: This is where you link the environment variable context 
          # You need to set the SONAR_TOKEN environment variable in CircleCI.
          context: sonarcloud-context